{% extends "games/base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-9">
    <div class="mb-4 jackpot">üí∞ –î–∂–µ–∫–ø–æ—Ç: {{ jackpot.amount }} $</div>

    {% if matches %}
      {% if round and round.status == "selection" %}
        <div id="bet-timer" class="alert alert-info">
          –î–æ –∫–æ–Ω—Ü–∞ –ø—Ä–∏—ë–º–∞ —Å—Ç–∞–≤–æ–∫: <span id="countdown"></span>
        </div>
      {% elif round %}
        <div class="alert alert-warning">
          –ü—Ä–∏—ë–º —Å—Ç–∞–≤–æ–∫ –∑–∞–∫—Ä—ã—Ç ‚Äî —Å—Ç–∞–¥–∏—è: {{ round.get_status_display }}
        </div>
      {% endif %}

      <div class="mb-3">
        <button type="button" id="randomize" class="btn btn-secondary">
          –†–∞–Ω–¥–æ–º–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
        </button>
      </div>

      <form method="post" action="{% url 'bet' %}">
        {% csrf_token %}

        {% for match in matches %}
          <div class="match-box">
            <div class="match-title">
              {{ match.team1.name }}¬†‚Äî¬†{{ match.team2.name }}
            </div>
            <div class="checkbox-group">
              {% for val, lab in outcome_choices %}
                <div class="form-check">
                  <input
                    class="form-check-input match-choice"
                    type="checkbox"
                    name="outcome_{{ match.id }}"
                    value="{{ val }}"
                    {% if round.status != 'selection' %}disabled{% endif %}
                  >
                  <label class="form-check-label">{{ lab }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}

        <div class="mb-3">
          <label for="amount_total" class="form-label">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏</label>
          <input
            type="number"
            name="amount_total"
            id="amount_total"
            class="form-control"
            step="0.01"
            min="0.01"
            value="0.5"
            required
            {% if round.status != 'selection' %}disabled{% endif %}
          >
        </div>

        <button
          type="submit"
          id="submitBtn"
          class="btn btn-success"
          disabled
          {% if round.status != 'selection' %}disabled{% endif %}
        >
          –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É
        </button>
      </form>
    {% else %}
      <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è —Å—Ç–∞–≤–æ–∫.</p>
    {% endif %}
  </div>

  <div class="col-md-3 right-panel">
    {% if round %}
      <h5>üéØ –ü—É–ª: {{ total_pool }} $</h5>
      <hr>
      {% if payout_categories %}
        <h6>üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–µ–π</h6>
        <ul class="list-unstyled">
          {% for cat in payout_categories %}
            <li>{{ cat.matched_count }} –∏—Å—Ö–æ–¥–æ–≤¬†‚Äî {{ cat.percent }}%</li>
          {% endfor %}
        </ul>
      {% else %}
        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤—ã–ø–ª–∞—Ç</p>
      {% endif %}
    {% else %}
      <p>–†–∞—É–Ω–¥ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.</p>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // === –¢–∞–π–º–µ—Ä –ø—Ä–∏—ë–º–∞ —Å—Ç–∞–≤–æ–∫ ===
  const countdownEl = document.getElementById("countdown");
  if (countdownEl) {
    const startTs = {{ start_timestamp }} * 1000;
    const deadline = startTs + 180 * 1000;
    if (Date.now() >= deadline) {
      countdownEl.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ";
      setInterval(() => location.reload(), 15000);
    } else {
      const tick = () => {
        const diff = deadline - Date.now();
        if (diff <= 0) {
          clearInterval(timerId);
          countdownEl.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ";
          setTimeout(() => location.reload(), 2000);
        } else {
          countdownEl.textContent = Math.floor(diff/1000) + " —Å–µ–∫.";
        }
      };
      tick();
      const timerId = setInterval(tick, 1000);
    }
  } else {
    setInterval(() => location.reload(), 15000);
  }

  // === –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã ===
  const submitBtn = document.getElementById("submitBtn");
  const choices   = document.querySelectorAll("input.match-choice");

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –≤–æ –≤—Å–µ—Ö –ª–∏ –º–∞—Ç—á-–±–æ–∫—Å–∞—Ö –≤—ã–±—Ä–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–µ–∫–±–æ–∫—Å
  function validateForm() {
    const allBoxes = document.querySelectorAll(".match-box");
    const ok = Array.from(allBoxes).every(box =>
      box.querySelector("input.match-choice:checked")
    );
    submitBtn.disabled = !ok;
  }

  // –ü–æ–≤–µ—Å–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∫–∞–∂–¥—ã–π —á–µ–∫–±–æ–∫—Å
  choices.forEach(ch => ch.addEventListener("change", validateForm));

  // === –†–∞–Ω–¥–æ–º–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ ===
  document.getElementById("randomize").addEventListener("click", () => {
    document.querySelectorAll(".match-box").forEach(box => {
      const opts = box.querySelectorAll("input.match-choice");
      opts.forEach(i => i.checked = false);
      const rnd = Math.floor(Math.random() * opts.length);
      opts[rnd].checked = true;
    });
    validateForm();
  });

  // –ü–µ—Ä–≤–∏—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  validateForm();
});
</script>
{% endblock %}
