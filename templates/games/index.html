{% extends "games/base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-9">
        <div class="mb-4 jackpot">üí∞ –î–∂–µ–∫–ø–æ—Ç: {{ jackpot.amount }} $</div>

        {% if matches %}
            {% if round and round.status == "selection" %}
              <div id="bet-timer" class="alert alert-info">
                –î–æ –∫–æ–Ω—Ü–∞ –ø—Ä–∏—ë–º–∞ —Å—Ç–∞–≤–æ–∫: <span id="countdown"></span>
              </div>
            {% elif round %}
              <div class="alert alert-warning">
                –ü—Ä–∏—ë–º —Å—Ç–∞–≤–æ–∫ –∑–∞–∫—Ä—ã—Ç ‚Äî —Å—Ç–∞–¥–∏—è: {{ round.get_status_display }}
              </div>
            {% endif %}
            <form method="post" action="{% url 'bet' %}">
              {% csrf_token %}
              {% for match in matches %}
                <div class="match-box">
                  <div class="match-title">{{ match.team1.name }} ‚Äî {{ match.team2.name }}</div>
                  <div class="checkbox-group">
                    {% for val, lab in outcome_choices %}
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="outcome_{{ match.id }}" value="{{ val }}"
                               {% if round.status != 'selection' %}disabled{% endif %}>
                        <label class="form-check-label">{{ lab }}</label>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}

              <div class="mb-3">
                <label for="amount_total" class="form-label">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏</label>
                <input type="number" name="amount_total" id="amount_total" class="form-control" step="0.01" min="1"
                       {% if round.status != 'selection' %}disabled{% endif %} required>
              </div>

              <button type="submit" class="btn btn-success"
                      {% if round.status != 'selection' %}disabled{% endif %}>
                –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É
              </button>
            </form>
        {% else %}
            <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è —Å—Ç–∞–≤–æ–∫.</p>
        {% endif %}
    </div>

    <div class="col-md-3 right-panel">
        {% if round %}
            <h5>üéØ –ü—É–ª: {{ total_pool }} $</h5>
            <hr>
            {% if payout_categories %}
                <h6>üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–µ–π</h6>
                <ul class="list-unstyled">
                    {% for cat in payout_categories %}
                        <li>{{ cat.matched_count }} –∏—Å—Ö–æ–¥–æ–≤ ‚Äî {{ cat.percent }}%</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤—ã–ø–ª–∞—Ç</p>
            {% endif %}
        {% else %}
            <p>–†–∞—É–Ω–¥ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.</p>
        {% endif %}
    </div>
</div>

<script>
  (function () {
    const countdownEl = document.getElementById("countdown");

    // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä –µ—Å—Ç—å
    if (countdownEl) {
      const startTimestamp = {{ start_timestamp }} * 1000;
      const deadline = startTimestamp + 180 * 1000;
      const now = Date.now();

      if (now >= deadline) {
        countdownEl.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ";

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
        setInterval(() => {
          location.reload();
        }, 500000);

        return;
      }

      function updateCountdown() {
        const now = Date.now();
        const diff = deadline - now;

        if (diff <= 0) {
          clearInterval(timerId);
          countdownEl.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ";
          setTimeout(() => location.reload(), 2000);
          return;
        }

        const seconds = Math.floor(diff / 1000);
        countdownEl.textContent = seconds + " —Å–µ–∫.";
      }

      updateCountdown();
      const timerId = setInterval(updateCountdown, 1000);

    } else {
      // –¢–∞–π–º–µ—Ä–∞ –Ω–µ—Ç –≤–æ–æ–±—â–µ ‚Äî –∑–Ω–∞—á–∏—Ç –Ω–µ —Å—Ç–∞–¥–∏—è –≤—ã–±–æ—Ä–∞
      setInterval(() => {
        location.reload();
      }, 500000);
    }
  })();
</script>
{% endblock %}
