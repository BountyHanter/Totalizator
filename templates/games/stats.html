{% extends "games/base.html" %}
{% load extras %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}
{% block content %}
<h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ä–∞—É–Ω–¥–æ–≤</h3>

<form method="get" class="mb-3">
  <label for="date">–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ —Å—Ç–∞—Ä—Ç–∞:</label>
  <input type="date" id="date" name="date" value="{{ selected_date }}">
  <button type="submit" class="btn btn-sm btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  <a href="{% url 'stats' %}" class="btn btn-sm btn-secondary">–°–±—Ä–æ—Å</a>
</form>

<table class="table table-bordered table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>–ù–∞—á–∞–ª–æ</th>
      <th>–ö–æ–Ω–µ—Ü</th>
      <th>–ü—É–ª</th>
      <th>–ú–∞—Ç—á–µ–π</th>
      <th>–ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</th>
      <th>–í—ã–∏–≥—Ä–∞–Ω–æ</th>
      <th>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rounds %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.start_time|date:"d.m.Y H:i" }}</td>
        <td>{{ r.end_time|date:"d.m.Y H:i" }}</td>
        <td>{{ r.total_pool }} $</td>
        <td>{{ r.match_count }}</td>
        <td>{{ user_staked|get:r.id|default:"0.00" }} $</td>
        <td>{{ user_won|get:r.id|default:"0.00" }} $</td>
        <td>
          {% if r.stats %}
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              data-bs-toggle="modal"
              data-bs-target="#statsModal{{ r.id }}"
            >
              –û—Ç–∫—Ä—ã—Ç—å
            </button>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{% for r in rounds %}
  {% if r.stats %}
    <!-- –ú–æ–¥–∞–ª–∫–∞ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="modal fade" id="statsModal{{ r.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—É–Ω–¥–∞ #{{ r.id }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div
            class="modal-body"
            id="statsModalBody{{ r.id }}"
            hx-get="{% url 'stats_round_partial' r.id %}"
            hx-trigger="revealed"
            hx-target="this"
            hx-swap="innerHTML"
          >
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–ú–æ–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã¬ª (–ø—É—Å—Ç–æ–π –∫–∞—Ä–∫–∞—Å, –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ HTMX) -->
    <div class="modal fade" id="userVariantsModal{{ r.id }}" tabindex="-1"
         aria-labelledby="userVariantsLabel{{ r.id }}" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userVariantsLabel{{ r.id }}">
              –ú–æ–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Äî —Ä–∞—É–Ω–¥ #{{ r.id }}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div
            class="modal-body"
            id="userVariantsBody{{ r.id }}"
            hx-get="{% url 'user_variants_partial' r.id %}"
            hx-trigger="revealed"
            hx-target="this"
            hx-swap="innerHTML"
          >
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
{% endfor %}

<script src="https://unpkg.com/htmx.org@1.9.2"></script>
{% endblock %}
